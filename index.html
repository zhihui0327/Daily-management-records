<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ—¥å¸¸æ”¯å‡ºç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --accent: #764ba2;
            --bg: #f3f4f6;
            --text: #374151;
            --text-light: #9ca3af;
            --white: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-info h1 { font-size: 24px; margin-bottom: 5px; }
        .header-info p { opacity: 0.9; font-size: 14px; }

        .month-selector {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            cursor: pointer;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-value { font-size: 32px; font-weight: 700; color: var(--text); }
        .stat-sub { font-size: 13px; color: var(--text-light); margin-top: 5px; }
        .stat-value.expense { color: var(--primary); }

        .input-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .form-group label { display: block; font-size: 12px; color: var(--text-light); margin-bottom: 5px; font-weight: 500;}
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            font-size: 14px;
            transition: all 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid #e5e7eb; color: var(--text); }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* å·¥å…·æ ï¼šæ§åˆ¶æœç´¢æ¡†å®½åº¦ */
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-box {
            width: 220px; /* é€‚ä¸­å®½åº¦ */
        }
        
        .table-responsive { overflow-x: auto; width: 100%; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px; color: var(--text-light); font-size: 12px; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: var(--text); vertical-align: middle; }
        
        .sort-btn { cursor: pointer; user-select: none; color: var(--primary); margin-left: 4px; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .editable-cell { cursor: pointer; border-bottom: 1px dashed #cbd5e1; }
        .editable-cell:hover { color: var(--primary); border-bottom-color: var(--primary); background: rgba(102, 126, 234, 0.05); }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header-card { padding: 20px; flex-direction: column; }
            .search-box { width: 100%; }
            .toolbar { width: 100%; flex-wrap: wrap; }
            .input-form { grid-template-columns: 1fr 1fr; }
            .input-form .form-group:last-child { grid-column: span 2; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="header-info">
            <h1>ğŸ’° æ”¯å‡ºç®¡ç†</h1>
            <p>æŒæ§è´¢åŠ¡ï¼Œç†æ€§æ¶ˆè´¹</p>
        </div>
        <input type="month" id="monthFilter" class="month-selector" onchange="handleMonthChange()">
    </div>

    <div class="dashboard-grid">
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="card">
                <div class="card-title">ğŸ“ å¿«é€Ÿè®°è´¦</div>
                <div class="input-form">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="dateInput" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±»</label>
                        <select id="categoryInput" class="form-control">
                            <option value="é¤é¥®">ğŸ” æ—©ä¸­æ™šé¤</option>
                            <option value="äº¤é€š">ğŸš— äº¤é€šè´¹</option>
                            <option value="åŠ å·¥">ğŸ› ï¸ åŠ å·¥</option>
                            <option value="ç§Ÿè½¦">ğŸš• ç§Ÿè½¦è´¹</option>
                            <option value="é«˜é€Ÿ">ğŸ›£ï¸ é«˜é€Ÿè´¹</option>
                            <option value="æ°´é¥®">â˜• å’–å•¡æ°´</option>
                            <option value="åœè½¦">ğŸ…¿ï¸ åœè½¦è´¹</option>
                            <option value="æ—¥ç»™">ğŸ’µ æ—¥ç»™</option>
                            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¢ (Â¥)</label>
                        <input type="number" id="amountInput" class="form-control" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="noteInput" class="form-control" placeholder="å¤‡æ³¨...">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addExpense()">æ·»åŠ æ”¯å‡º</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid" style="gap: 15px;">
                <div class="card" style="padding: 20px;"><div class="card-title">æœ¬æœˆæ”¯å‡º</div><div class="stat-value expense" id="monthTotal">Â¥0.00</div><div class="stat-sub" id="recordCount">å…± 0 ç¬”</div></div>
                <div class="card" style="padding: 20px;"><div class="card-title">ä»Šæ—¥æ”¯å‡º</div><div class="stat-value" id="todayTotal">Â¥0.00</div><div class="stat-sub">å®æ—¶ç»Ÿè®¡</div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><span>ğŸ“Š æ¶ˆè´¹æ„æˆ</span><span class="badge" style="background:#f3f4f6; color:#666" id="chartMonthLabel">æœ¬æœˆ</span></div>
            <div class="chart-container"><canvas id="expenseChart"></canvas></div>
            <div id="noChartData" style="display:none; text-align:center; padding-top:40px; color:#999;">æœ¬æœˆæš‚æ— æ•°æ®</div>
        </div>
    </div>

    <div class="card">
        <div class="card-title">
            <span>ğŸ“œ è´¦å•æ˜ç»†</span>
            <div class="toolbar">
                <input type="text" id="searchInput" class="form-control search-box" placeholder="ğŸ” æœç´¢å¤‡æ³¨æˆ–é‡‘é¢..." onkeyup="filterTable()">
                <button class="btn btn-outline" onclick="exportExcel()">å¯¼å‡ºExcel</button>
                <button class="btn btn-danger" onclick="clearAll()" style="padding: 8px 12px;">ğŸ—‘ï¸</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th width="18%">æ—¥æœŸ <span class="sort-btn" onclick="toggleSort()">ğŸ”ƒ</span></th>
                        <th width="18%">åˆ†ç±»</th>
                        <th width="15%">é‡‘é¢</th>
                        <th width="34%">å¤‡æ³¨</th>
                        <th width="15%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="expenseTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    const STORAGE_KEY = 'expenses_pro_v2';
    const categoryConfig = {
        'é¤é¥®': { icon: 'ğŸ”', color: '#ff6b6b' }, 'äº¤é€š': { icon: 'ğŸš—', color: '#4ecdc4' },
        'åŠ å·¥': { icon: 'ğŸ› ï¸', color: '#ff9f43' }, 'ç§Ÿè½¦': { icon: 'ğŸš•', color: '#a55eea' },
        'é«˜é€Ÿ': { icon: 'ğŸ›£ï¸', color: '#54a0ff' }, 'æ°´é¥®': { icon: 'â˜•', color: '#48dbfb' },
        'åœè½¦': { icon: 'ğŸ…¿ï¸', color: '#ff7675' }, 'æ—¥ç»™': { icon: 'ğŸ’µ', color: '#2ecc71' },
        'å…¶ä»–': { icon: 'ğŸ“¦', color: '#a4b0be' }
    };

    let expenses = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let expenseChart = null;
    let sortAsc = false; // é»˜è®¤é™åºï¼ˆä»æ–°åˆ°æ—§ï¼‰
    let currentDisplayData = []; // å­˜å‚¨å½“å‰ç”»é¢æ˜¾ç¤ºçš„æ•°æ®ï¼Œç”¨äºå¯¼å‡º

    const today = new Date();
    document.getElementById('monthFilter').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    document.getElementById('dateInput').value = today.toISOString().split('T')[0];

    function saveExpenses() { localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses)); refreshUI(); }

    function refreshUI() {
        const selectedMonth = document.getElementById('monthFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        // è¿‡æ»¤
        let filtered = expenses.filter(item => {
            return item.date.startsWith(selectedMonth) && 
                   (item.note.toLowerCase().includes(searchTerm) || 
                    item.amount.toString().includes(searchTerm) ||
                    item.category.includes(searchTerm));
        });

        // æ’åº
        filtered.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            return sortAsc ? dateA - dateB : dateB - dateA;
        });

        currentDisplayData = filtered; // åŒæ­¥å½“å‰æ˜¾ç¤ºæ•°æ®
        renderTable(filtered);
        
        const monthFullData = expenses.filter(item => item.date.startsWith(selectedMonth));
        updateStats(monthFullData);
        renderChart(monthFullData);
    }

    function toggleSort() {
        sortAsc = !sortAsc;
        refreshUI();
    }

    function addExpense() {
        const date = document.getElementById('dateInput').value;
        const category = document.getElementById('categoryInput').value;
        const amount = parseFloat(document.getElementById('amountInput').value);
        const note = document.getElementById('noteInput').value;
        if (!date || isNaN(amount) || amount <= 0) return alert('è¯·å¡«å†™æ­£ç¡®å†…å®¹');
        expenses.unshift({ id: Date.now(), date, category, amount, note });
        saveExpenses();
        document.getElementById('amountInput').value = '';
        document.getElementById('noteInput').value = '';
    }

    function editCell(id, field) {
        const item = expenses.find(e => e.id === id);
        if (!item) return;
        let val = prompt(`ä¿®æ”¹${field}:`, item[field]);
        if (val === null) return;
        if (field === 'amount') {
            val = parseFloat(val);
            if (isNaN(val) || val <= 0) return alert("æ— æ•ˆé‡‘é¢");
        }
        item[field] = val;
        saveExpenses();
    }

    function renderTable(data) {
        const tbody = document.getElementById('expenseTable');
        tbody.innerHTML = data.length === 0 ? '<tr><td colspan="5" style="text-align:center; padding:30px; color:#999">ğŸ‘» æ— è®°å½•</td></tr>' : 
        data.map(item => {
            const cfg = categoryConfig[item.category] || categoryConfig['å…¶ä»–'];
            return `<tr>
                <td class="editable-cell" onclick="editCell(${item.id}, 'date')">${item.date}</td>
                <td class="editable-cell" onclick="editCell(${item.id}, 'category')"><span class="badge" style="background:${cfg.color}20; color:${cfg.color}">${cfg.icon} ${item.category}</span></td>
                <td class="editable-cell" onclick="editCell(${item.id}, 'amount')" style="font-weight:bold; color:${cfg.color}">Â¥${item.amount.toFixed(2)}</td>
                <td class="editable-cell" onclick="editCell(${item.id}, 'note')">${item.note || '-'}</td>
                <td><button class="btn btn-outline" style="padding:4px 8px; font-size:12px; color:#ef4444;" onclick="deleteExpense(${item.id})">åˆ é™¤</button></td>
            </tr>`;
        }).join('');
    }

    function deleteExpense(id) { if(confirm('åˆ é™¤å—ï¼Ÿ')) { expenses = expenses.filter(e => e.id !== id); saveExpenses(); } }
    function clearAll() { if(confirm('å…¨éƒ¨æ¸…ç©ºå—ï¼Ÿ')) { expenses = []; saveExpenses(); } }
    function handleMonthChange() { document.getElementById('chartMonthLabel').textContent = document.getElementById('monthFilter').value; refreshUI(); }
    function filterTable() { refreshUI(); }

    function updateStats(data) {
        const total = data.reduce((sum, item) => sum + item.amount, 0);
        document.getElementById('monthTotal').textContent = `Â¥${total.toFixed(2)}`;
        document.getElementById('recordCount').textContent = `æœ¬æœˆå…± ${data.length} ç¬”`;
        const todayStr = new Date().toISOString().split('T')[0];
        const todaySum = expenses.filter(e => e.date === todayStr).reduce((sum, e) => sum + e.amount, 0);
        document.getElementById('todayTotal').textContent = `Â¥${todaySum.toFixed(2)}`;
    }

    function renderChart(data) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        if (data.length === 0) { document.getElementById('expenseChart').style.display = 'none'; document.getElementById('noChartData').style.display = 'block'; return; }
        document.getElementById('expenseChart').style.display = 'block';
        document.getElementById('noChartData').style.display = 'none';
        const catMap = {};
        data.forEach(item => catMap[item.category] = (catMap[item.category] || 0) + item.amount);
        const labels = Object.keys(catMap);
        const values = Object.values(catMap);
        if (expenseChart) expenseChart.destroy();
        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data: values, backgroundColor: labels.map(l => (categoryConfig[l] || categoryConfig['å…¶ä»–']).color), borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '65%' }
        });
    }

    function exportExcel() {
        if (!currentDisplayData.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        // æŒ‰ç…§å½“å‰ç”»é¢æ˜¾ç¤ºçš„é¡ºåºè¿›è¡Œå¯¼å‡º
        const ws = XLSX.utils.json_to_sheet(currentDisplayData.map(e => ({
            "æ—¥æœŸ": e.date, "åˆ†ç±»": e.category, "é‡‘é¢": e.amount, "å¤‡æ³¨": e.note
        })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æ”¯å‡ºè®°å½•");
        XLSX.writeFile(wb, `æ”¯å‡ºæ˜ç»†_${document.getElementById('monthFilter').value}_${sortAsc?'å‡åº':'é™åº'}.xlsx`);
    }

    refreshUI();
</script>
</body>
</html>
